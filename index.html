<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ligue de Soccer Joga Bonito</title>
  <style>
    /* Reset & Global Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent; color: #f9fafb;
    }

    .football-widget {
      max-width: 1000px; margin: 0 auto; padding: 20px;
      background: rgba(255,255,255,0.05); backdrop-filter: blur(8px); border-radius: 16px;
    }

    .widget-header { margin-bottom: 16px; }
    .top-row {
      display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap;
    }

    .widget-title {
      font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 10px;
    }
    .widget-subtitle { color: #d1d5db; font-size: 14px; margin-top: 4px; }

    /* League dropdown */
    .league-select {
      display: flex; align-items: center; gap: 8px;
      background: rgba(255,255,255,0.12); border-radius: 10px; padding: 6px 10px;
    }
    .league-select label { font-size: 14px; color: #e5e7eb; }
    .league-select select {
      appearance: none; border: none; outline: none;
      background: rgba(255,255,255,0.2); color: #fff;
      padding: 6px 10px; border-radius: 8px; cursor: pointer;
    }

    /* Journee nav, cards, etc. */
    .journee-nav { display: flex; align-items: center; gap: 8px; margin: 16px 0 24px; flex-wrap: wrap; }
    .nav-label { font-weight: 500; color: #f9fafb; }
    .journee-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .journee-btn {
      padding: 8px 16px; border-radius: 12px; border: none; font-size: 14px; font-weight: 500; cursor: pointer;
      background: rgba(255,255,255,0.15); color: #f9fafb; transition: background 0.2s ease;
    }
    .journee-btn:not(.active):hover { background: rgba(255,255,255,0.3); }
    .journee-btn.active { background: #2563eb; color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.4); }

    .match-card { background: rgba(255,255,255,0.08); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 16px; transition: all 0.3s ease; }
    .match-card:hover { background: rgba(255,255,255,0.12); }
    .match-header { padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,0.1); color: #f9fafb; }
    .match-info { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #d1d5db; }
    .time-venue { display: flex; gap: 16px; }

    .match-details { padding: 20px 16px; }
    .teams-container { display: flex; align-items: center; justify-content: space-between; }
    .team { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 0; }
    .team-2 { justify-content: flex-end; flex-direction: row-reverse; }
    .team-logo { width: 36px; height: 36px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.2); }
    .team-logo img { width: 100%; height: 100%; object-fit: contain; display: block; }
    .team-name { font-weight: 600; color: #f9fafb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .team-2 .team-name { text-align: right; }

    .score-section { margin: 0 32px; display: flex; align-items: center; justify-content: center; min-width: 80px; }
    .score-display { display: flex; align-items: center; gap: 12px; }
    .score { font-size: 32px; font-weight: bold; color: #fff; }
    .score.pending { color: #9ca3af; letter-spacing: 2px; }
    .separator { color: #9ca3af; font-size: 24px; }

    .status-container { display: flex; justify-content: center; margin-top: 16px; }
    .status-badge { padding: 6px 14px; border-radius: 14px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; backdrop-filter: blur(6px); }
    .status-finished { background: rgba(16,185,129,0.2); color: #10b981; }
    .status-draw { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .status-forfeit { background: rgba(239,68,68,0.2); color: #ef4444; }

    .no-matches { text-align: center; padding: 48px 20px; color: #f9fafb; }
    .no-matches-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    .no-matches h3 { font-size: 18px; font-weight: 500; margin-bottom: 8px; }
    .no-matches p { color: #d1d5db; }

    @media (max-width: 768px) {
      .teams-container { flex-direction: column; gap: 16px; }
      .score-section { margin: 16px 0; }
      .team-2 { flex-direction: row-reverse; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="football-widget">
    <div class="widget-header">
      <div class="top-row">
        <div>
          <h1 class="widget-title">
            <span class="title-icon">üë•</span>
            <span id="leagueTitle">Club Tomohawk 2025</span>
          </h1>
          <p class="widget-subtitle" id="leagueSub">Calendrier et r√©sultats</p>
        </div>
        <div class="league-select">
          <label for="leagueSelect">Ligue :</label>
          <select id="leagueSelect"></select>
        </div>
      </div>
    </div>

    <div id="widget-content">
      <div class="loading">
        <h3>Chargement des matchs...</h3>
        <p>En attente des donn√©es depuis Wix</p>
      </div>
    </div>
  </div>

  <script>
    let currentMatchData = {};
    let selectedJournee = "1";
    let leagues = [];            // [{id,label,div}]
    let currentLeagueId = null;  // e.g., 'Tr1'

    function postToParent(msg) {
      try { window.parent.postMessage(msg, '*'); } catch (_) {}
    }

    // Inform Wix we‚Äôre ready
    window.addEventListener('load', () => {
      postToParent({ type: 'IFRAME_READY' });
    });

    function populateLeagueDropdown() {
      const sel = document.getElementById('leagueSelect');
      sel.innerHTML = leagues.map(l => `<option value="${l.id}">${l.label}</option>`).join('');
      if (currentLeagueId && leagues.find(l => l.id === currentLeagueId)) {
        sel.value = currentLeagueId;
      } else if (leagues.length) {
        currentLeagueId = leagues[0].id;
        sel.value = currentLeagueId;
      }
    }

    document.getElementById('leagueSelect').addEventListener('change', (e) => {
      currentLeagueId = e.target.value;
      // Ask Wix for this league‚Äôs data
      postToParent({ type: 'SELECT_LEAGUE', leagueId: currentLeagueId });
      // Optimistic UI: show loading while waiting
      document.getElementById('widget-content').innerHTML = `
        <div class="no-matches">
          <div class="no-matches-icon">‚è≥</div>
          <h3>Chargement des matchs‚Ä¶</h3>
          <p>R√©cup√©ration des donn√©es pour la ligue s√©lectionn√©e.</p>
        </div>`;
    });

    function getMatchStatus(match) {
      if (!match.equipeGagnante || match.equipeGagnante === "undefined") return 'SCHEDULED';
      if (match.forfait) return 'FORFEIT';
      if (match.nul) return 'DRAW';
      return 'FINISHED';
    }

    function getMatchResult(match) {
      const status = getMatchStatus(match);
      if (status === 'SCHEDULED' || match.forfait) return { team1Score: '-', team2Score: '-' };
      return { team1Score: match.egNbButs, team2Score: match.epNbButs };
    }

    function formatDate(dateInput) {
      const s = (dateInput || '').trim();
      const looksISO = /^\d{4}-\d{2}-\d{2}/.test(s);
      if (looksISO) {
        const d = new Date(s);
        if (!isNaN(d)) {
          return d.toLocaleDateString('fr-CA', { weekday: 'short', month: 'short', day: 'numeric' });
        }
      }
      return s || 'Date √† venir';
    }

    function createMatchCard(match) {
      const status = getMatchStatus(match);
      const result = getMatchResult(match);
      const statusText = { SCHEDULED: '', FORFEIT: 'Forfait', DRAW: 'Match nul', FINISHED: 'Termin√©' }[status] || '';
      return `
        <div class="match-card">
          <div class="match-header">
            <div class="match-info">
              <div class="date-info"><span>üìÖ</span><span> ${formatDate(match.date)}</span></div>
              <div class="time-venue">
                <div class="time-info"><span>üïê</span><span> ${match.heure}</span></div>
                <div class="venue-info"><span>üìç</span><span> ${match.terrain}</span></div>
              </div>
            </div>
          </div>
          <div class="match-details">
            <div class="teams-container">
              <div class="team team-1">
                <div class="team-logo">
                  ${match.equipe1Logo ? `<img src="${match.equipe1Logo}" alt="${match.equipe1}" width="36" height="36" loading="lazy">` : '‚öΩ'}
                </div>
                <div class="team-name">${match.equipe1}</div>
              </div>
              <div class="score-section">
                ${status === 'SCHEDULED'
                  ? `<div class="score-display"><span class="score pending">- - -</span></div>`
                  : `<div class="score-display"><span class="score">${result.team1Score}</span><span class="separator">-</span><span class="score">${result.team2Score}</span></div>`}
              </div>
              <div class="team team-2">
                <div class="team-logo">
                  ${match.equipe2Logo ? `<img src="${match.equipe2Logo}" alt="${match.equipe2}" width="36" height="36" loading="lazy">` : '‚öΩ'}
                </div>
                <div class="team-name">${match.equipe2}</div>
              </div>
            </div>
            ${status !== 'SCHEDULED' ? `<div class="status-container"><span class="status-badge status-${status.toLowerCase()}">${statusText}</span></div>` : ``}
          </div>
        </div>`;
    }

    function renderWidget() {
      const journees = Object.keys(currentMatchData).sort((a, b) => Number(a) - Number(b));
      let currentMatches = (currentMatchData[selectedJournee] || []).slice().sort((a, b) => {
        const ordreA = a.ordreDate ?? Number.MAX_SAFE_INTEGER;
        const ordreB = b.ordreDate ?? Number.MAX_SAFE_INTEGER;
        return ordreA - ordreB;
      });

      const content = `
        <div class="journee-nav">
          <span class="nav-label">Date :</span>
          <div class="journee-buttons">
            ${journees.map(j => {
              const first = (currentMatchData[j] && currentMatchData[j][0]) || {};
              const label = first.date ? formatDate(first.date) : `Journ√©e ${j}`;
              return `<button class="journee-btn ${selectedJournee === j ? 'active' : ''}" onclick="selectJournee('${j}')">${label}</button>`;
            }).join('')}
          </div>
        </div>
        <div class="matches-container">
          ${currentMatches.length > 0
            ? currentMatches.map(match => createMatchCard(match)).join('')
            : `<div class="no-matches"><div class="no-matches-icon">‚öΩ</div><h3>Aucun match programm√©</h3><p>Revenez plus tard pour voir les prochains matchs.</p></div>`
          }
        </div>
      `;
      document.getElementById('widget-content').innerHTML = content;
    }

    function updateMatchData(bundle) {
      // bundle = { leagueId, leagueMeta, data }
      currentMatchData = bundle.data || {};
      // choose first journee by default
      const journees = Object.keys(currentMatchData).sort((a, b) => Number(a) - Number(b));
      if (journees.length) selectedJournee = journees[0];

      // Update header
      if (bundle.leagueMeta) {
        const { label, div } = bundle.leagueMeta;
        document.getElementById('leagueTitle').textContent = `${div || label || 'Ligue'} 2025`;
        document.getElementById('leagueSub').textContent = 'Calendrier et r√©sultats';
      }

      // Sync dropdown selection, if present
      if (bundle.leagueId) {
        currentLeagueId = bundle.leagueId;
        const sel = document.getElementById('leagueSelect');
        if (sel && currentLeagueId) sel.value = currentLeagueId;
      }

      renderWidget();
    }

    function selectJournee(journee) {
      selectedJournee = journee;
      renderWidget();
    }
    window.selectJournee = selectJournee;

    // Receive messages from Wix
    window.addEventListener('message', function(event) {
      const msg = event.data || {};
      if (msg.type === 'INIT_LEAGUES' && Array.isArray(msg.payload)) {
        leagues = msg.payload.slice();
        populateLeagueDropdown();
        // If we have a selection, ask for it; else default to first
        const desired = currentLeagueId || (leagues[0] && leagues[0].id);
        if (desired) postToParent({ type: 'SELECT_LEAGUE', leagueId: desired });
      }
      if (msg.type === 'SET_MATCH_DATA' && msg.payload) {
        updateMatchData(msg.payload);
      }
    }, false);
  </script>
</body>
</html>
