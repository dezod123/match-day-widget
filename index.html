<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ligue de Soccer Joga Bonito</title>
  <style>
    /* Reset & Global Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden; /* Removes iframe scrollbar */
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: transparent;
      color: #f9fafb;
    }

    /* Widget Container */
    .football-widget {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(8px);
      border-radius: 16px;
    }

    /* Header */
    .widget-header {
      margin-bottom: 32px;
    }

    .widget-title {
      font-size: 32px;
      font-weight: bold;
      color: #ffffff;
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      text-align: center;
    }

    .title-icon {
      margin-right: 12px;
      font-size: 32px;
    }

    .widget-subtitle {
      color: #d1d5db;
      font-size: 14px;
    }

    /* Navigation */
    .journee-nav {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .nav-label {
      font-weight: 500;
      color: #f9fafb;
    }

    .journee-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .journee-btn {
      padding: 8px 16px;
      border-radius: 12px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.15);
      color: #f9fafb;
      transition: background 0.2s ease;
    }

    .journee-btn:not(.active):hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .journee-btn.active {
      background: #2563eb;
      color: #fff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    /* Match Card */
    .match-card {
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      margin-bottom: 16px;
      transition: all 0.3s ease;
      padding: 0;
    }

    .match-card:hover {
      background: rgba(255, 255, 255, 0.12);
    }

    /* Card Header */
    .match-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: #f9fafb;
    }

    .match-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: #d1d5db;
    }

    .time-venue {
      display: flex;
      gap: 16px;
    }

    /* Match Body */
    .match-details {
      padding: 20px 16px;
    }

    .teams-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* Teams */
    .team {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .team-2 {
      justify-content: flex-end;
      flex-direction: row-reverse;
    }

    .team-logo {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.2);
    }

    .team-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .team-name {
      font-weight: 600;
      color: #f9fafb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .team-2 .team-name {
      text-align: right;
    }

    /* Score Section */
    .score-section {
      margin: 0 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
    }

    .score-display {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .score {
      font-size: 32px;
      font-weight: bold;
      color: #fff;
    }

    .score.pending {
      color: #9ca3af;
      letter-spacing: 2px;
    }

    .separator {
      color: #9ca3af;
      font-size: 24px;
    }

    /* Status Badge */
    .status-container {
      display: flex;
      justify-content: center;
      margin-top: 16px;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      backdrop-filter: blur(6px);
    }

    .status-finished {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .status-draw {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .status-forfeit {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    /* No Matches */
    .no-matches {
      text-align: center;
      padding: 48px 20px;
      color: #f9fafb;
    }

    .no-matches-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .no-matches h3 {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .no-matches p {
      color: #d1d5db;
    }

    /* Responsive Fix */
    @media (max-width: 768px) {
      .teams-container {
        flex-direction: column;
        gap: 16px;
      }
      .score-section {
        margin: 16px 0;
      }
      .team-2 {
        flex-direction: row-reverse;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="football-widget">
    <div class="widget-header">
      <h1 class="widget-title">
        <span class="title-icon">üë•</span>
        Club Tomohawk 2025
      </h1>
      <p class="widget-subtitle">Calendrier et r√©sultats</p>
    </div>

    <div id="widget-content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <h3>Chargement des matchs...</h3>
        <p>En attente des donn√©es depuis Wix</p>
      </div>
    </div>
  </div>

  <script>
    let currentMatchData = {};
    let selectedJournee = "1";

    // (Optional) Emoji fallbacks
    const teamLogos = {
      "Blue Lock": "üîµ",
      "Royal Academy": "üëë",
      "Kelb United": "üêï",
      "Leaf": "üçÉ",
      "ESL": "‚öΩ",
      "CHAKS": "‚öΩ",
      "UST": "‚öΩ"
    };

    /* -------------------- Helpers -------------------- */

    function getMatchStatus(match) {
      if (!match.equipeGagnante || match.equipeGagnante === "undefined") {
        return 'SCHEDULED';
      }
      if (match.forfait) return 'FORFEIT';
      if (match.nul) return 'DRAW';
      return 'FINISHED';
    }

    function formatDate(dateInput) {
      const s = (dateInput || '').trim();
      const looksISO = /^\d{4}-\d{2}-\d{2}/.test(s);
      if (looksISO) {
        const d = new Date(s);
        if (!isNaN(d)) {
          return d.toLocaleDateString('fr-CA', {
            weekday: 'short',
            month: 'short',
            day: 'numeric'
          });
        }
      }
      return s || 'Date √† venir';
    }

    // Normalize and display helpers (for matching gagnant/perdant to equipe1/equipe2)
    function norm(val) {
      if (val == null) return '';
      if (typeof val === 'object') {
        return (val.title || val.name || val.value || '').toString().trim().toLowerCase();
      }
      return String(val).trim().toLowerCase();
    }

    function displayName(val) {
      if (val == null) return '';
      if (typeof val === 'object') {
        return (val.title || val.name || val.value || '').toString().trim();
      }
      return String(val).trim();
    }

    function isSameTeam(ref, nameCandidate) {
      const nRef = norm(ref);
      const nName = norm(nameCandidate);
      if (!nRef && !nName) return false;
      return nRef === nName;
    }

    function pickLogoFor(ref, match) {
      if (isSameTeam(ref, match.equipe1)) return match.equipe1Logo || '';
      if (isSameTeam(ref, match.equipe2)) return match.equipe2Logo || '';
      if (norm(displayName(ref)) === norm(match.equipe1)) return match.equipe1Logo || '';
      if (norm(displayName(ref)) === norm(match.equipe2)) return match.equipe2Logo || '';
      return '';
    }

    function pickNameFor(ref, match) {
      if (isSameTeam(ref, match.equipe1)) return match.equipe1;
      if (isSameTeam(ref, match.equipe2)) return match.equipe2;
      const d = displayName(ref);
      if (d) return d;
      return '√âquipe';
    }

    // Build left/right sides for display: winner (left) vs loser (right)
    function computeSides(match) {
      const status = getMatchStatus(match);

      // Defaults (original order)
      let leftTeamName = match.equipe1;
      let rightTeamName = match.equipe2;
      let leftTeamLogo = match.equipe1Logo || '';
      let rightTeamLogo = match.equipe2Logo || '';
      let leftGoals = '-';
      let rightGoals = '-';

      if (status === 'FINISHED') {
        // winner on the left, loser on the right
        leftTeamName = pickNameFor(match.equipeGagnante, match);
        rightTeamName = pickNameFor(match.equipePerdante, match);
        leftTeamLogo = pickLogoFor(match.equipeGagnante, match);
        rightTeamLogo = pickLogoFor(match.equipePerdante, match);

        // goals aligned to winner/loser
        leftGoals = (match.egNbButs ?? match.egNbButs === 0) ? match.egNbButs : '-';
        rightGoals = (match.epNbButs ?? match.epNbButs === 0) ? match.epNbButs : '-';
      } else if (status === 'DRAW') {
        // original order; show scores as recorded
        leftGoals = (match.egNbButs ?? match.egNbButs === 0) ? match.egNbButs : '-';
        rightGoals = (match.epNbButs ?? match.epNbButs === 0) ? match.epNbButs : '-';
      } else {
        // SCHEDULED / FORFEIT ‚Üí dashes
        leftGoals = rightGoals = '-';
      }

      return {
        status,
        leftTeamName, rightTeamName,
        leftTeamLogo, rightTeamLogo,
        leftGoals, rightGoals
      };
    }

    /* -------------------- Card Builder -------------------- */

    function createMatchCard(match) {
      const {
        status,
        leftTeamName, rightTeamName,
        leftTeamLogo, rightTeamLogo,
        leftGoals, rightGoals
      } = computeSides(match);

      const statusText = {
        'SCHEDULED': '',
        'FORFEIT': 'Forfait',
        'DRAW': 'Match nul',
        'FINISHED': 'Termin√©'
      }[status] || '';

      const scoreHtml = (status === 'SCHEDULED' || match.forfait)
        ? '<div class="score-display"><span class="score pending">- - -</span></div>'
        : '<div class="score-display">'
            + '<span class="score">' + leftGoals + '</span>'
            + '<span class="separator">-</span>'
            + '<span class="score">' + rightGoals + '</span>'
          + '</div>';

      const leftLogoHtml = leftTeamLogo
        ? '<img src="' + leftTeamLogo + '" alt="' + leftTeamName + '" width="36" height="36" loading="lazy">'
        : '‚öΩ';
      const rightLogoHtml = rightTeamLogo
        ? '<img src="' + rightTeamLogo + '" alt="' + rightTeamName + '" width="36" height="36" loading="lazy">'
        : '‚öΩ';

      return ''
        + '<div class="match-card">'
          + '<div class="match-header">'
            + '<div class="match-info">'
              + '<div class="date-info">'
                + '<span>üìÖ</span>'
                + '<span>' + formatDate(match.date) + '</span>'
              + '</div>'
              + '<div class="time-venue">'
                + '<div class="time-info">'
                  + '<span>üïê</span>'
                  + '<span>' + (match.heure || '') + '</span>'
                + '</div>'
                + '<div class="venue-info">'
                  + '<span>üìç</span>'
                  + '<span>' + (match.terrain || '') + '</span>'
                + '</div>'
              + '</div>'
            + '</div>'
          + '</div>'

          + '<div class="match-details">'
            + '<div class="teams-container">'

              // LEFT = winner (if finished), else equipe1
              + '<div class="team team-1">'
                + '<div class="team-logo">' + leftLogoHtml + '</div>'
                + '<div class="team-name">' + leftTeamName + '</div>'
              + '</div>'

              + '<div class="score-section">' + scoreHtml + '</div>'

              // RIGHT = loser (if finished), else equipe2
              + '<div class="team team-2">'
                + '<div class="team-logo">' + rightLogoHtml + '</div>'
                + '<div class="team-name">' + rightTeamName + '</div>'
              + '</div>'

            + '</div>'

            + (status !== 'SCHEDULED'
              ? '<div class="status-container">'
                  + '<span class="status-badge status-' + status.toLowerCase() + '">'
                    + statusText
                  + '</span>'
                + '</div>'
              : '')

          + '</div>'
        + '</div>';
    }

    /* -------------------- Rendering -------------------- */

    function renderWidget() {
      const journees = Object.keys(currentMatchData).sort(function(a, b) { return Number(a) - Number(b); });
      let currentMatches = currentMatchData[selectedJournee] || [];
      currentMatches = currentMatches.sort(function(a, b) {
        const ordreA = (a.ordreDate !== undefined && a.ordreDate !== null) ? a.ordreDate : Number.MAX_SAFE_INTEGER;
        const ordreB = (b.ordreDate !== undefined && b.ordreDate !== null) ? b.ordreDate : Number.MAX_SAFE_INTEGER;
        return ordreA - ordreB;
      });

      var buttonsHtml = '';
      for (var i = 0; i < journees.length; i++) {
        var j = journees[i];
        var first = (currentMatchData[j] && currentMatchData[j][0]) || {};
        var label = first.date ? formatDate(first.date) : ('Journ√©e ' + j);
        buttonsHtml += ''
          + '<button class="journee-btn ' + (selectedJournee === j ? 'active' : '') + '"'
          + ' onclick="selectJournee(\'' + j + '\')">'
          + label
          + '</button>';
      }

      var matchesHtml = '';
      if (currentMatches.length > 0) {
        for (var k = 0; k < currentMatches.length; k++) {
          matchesHtml += createMatchCard(currentMatches[k]);
        }
      } else {
        matchesHtml = ''
          + '<div class="no-matches">'
            + '<div class="no-matches-icon">‚öΩ</div>'
            + '<h3>Aucun match programm√©</h3>'
            + '<p>Revenez plus tard pour voir les prochains matchs.</p>'
          + '</div>';
      }

      var content = ''
        + '<div class="journee-nav">'
          + '<span class="nav-label">Date :</span>'
          + '<div class="journee-buttons">' + buttonsHtml + '</div>'
        + '</div>'
        + '<div class="matches-container">' + matchesHtml + '</div>';

      document.getElementById('widget-content').innerHTML = content;
    }

    function updateMatchData(data) {
      currentMatchData = data || {};
      const journees = Object.keys(currentMatchData).sort(function(a, b) { return Number(a) - Number(b); });
      if (journees.length > 0) {
        selectedJournee = journees[0];
      }
      renderWidget();
    }

    function selectJournee(journee) {
      selectedJournee = journee;
      renderWidget();
    }

    window.selectJournee = selectJournee;

    // Listen for Wix postMessage (payload shape unchanged)
    window.addEventListener('message', function(event) {
      if (event && event.data && typeof event.data === 'object' && event.data.type === 'SET_MATCH_DATA') {
        updateMatchData(event.data.payload);
      }
    }, false);
  </script>
</body>
</html>
